import torch
from metrics import MetronAtK


class Engine(object):
    #Meta Engine for training & evaluating NCF model
    def __init__(self):
        self._metron = MetronAtK(top_k=10)
       

    def evaluate(self,model, evaluate_data, epoch_id):
        model.eval()
        with torch.no_grad():
            test_users, test_items = evaluate_data[0], evaluate_data[1]
            negative_users, negative_items = evaluate_data[2], evaluate_data[3]
            
            test_users = test_users.cuda()
            test_items = test_items.cuda()
            negative_users = negative_users.cuda()
            negative_items = negative_items.cuda()
            test_scores = model(test_users, test_items)
            negative_scores = model(negative_users, negative_items)
            
            #to cpu
            test_users = test_users.cpu()
            test_items = test_items.cpu()
            test_scores = test_scores.cpu()
            negative_users = negative_users.cpu()
            negative_items = negative_items.cpu()
            negative_scores = negative_scores.cpu()
            self._metron.subjects = [test_users.data.view(-1).tolist(),
                                 test_items.data.view(-1).tolist(),
                                 test_scores.data.view(-1).tolist(),
                                 negative_users.data.view(-1).tolist(),
                                 negative_items.data.view(-1).tolist(),
                                 negative_scores.data.view(-1).tolist()]
        hit_ratio, ndcg = self._metron.cal_hit_ratio(), self._metron.cal_ndcg()
        print('[Evluating Epoch {}] HR = {:.4f}, NDCG = {:.4f}'.format(epoch_id, hit_ratio, ndcg))
        return hit_ratio, ndcg
    '''
    def save(self, model):
        assert hasattr(self, 'model'), 'Please specify the exact model !'
        model_dir = 'daintlab/'
        save_checkpoint(model, model_dir)
    '''    